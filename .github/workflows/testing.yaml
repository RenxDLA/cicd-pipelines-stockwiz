name: Post-Deployment Tests

# Se ejecuta luego de que se sube una imagen y se despliega en ECS
on:
  workflow_run:
    workflows: ["Build & Deploy Microservices"]
    types:
      - completed
  workflow_dispatch:

env:
  AWS_REGION: us-east-1

jobs:
  k6-load-tests:
    name: k6 Load & Performance Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Checkout CI/CD Repo
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          if [[ "${GITHUB_REF##*/}" == "develop" ]]; then
            echo "ENVIRONMENT=dev" >> $GITHUB_ENV
            echo "SERVICE_URL=${{ secrets.SERVICE_URL_DEV }}" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF##*/}" == "test" ]]; then
            echo "ENVIRONMENT=test" >> $GITHUB_ENV
            echo "SERVICE_URL=${{ secrets.SERVICE_URL_TEST }}" >> $GITHUB_ENV
          elif [[ "${GITHUB_REF##*/}" == "main" ]]; then
            echo "ENVIRONMENT=prod" >> $GITHUB_ENV
            echo "SERVICE_URL=${{ secrets.SERVICE_URL_PROD }}" >> $GITHUB_ENV
          fi

      - name: Run k6 load tests
        run: |
          docker run --rm -i \
            -e SERVICE_URL=${{ env.SERVICE_URL }} \
            -v ${{ github.workspace }}:/workspace \
            grafana/k6 run /workspace/tests/k6/load-test.js \
            --out json=/workspace/k6-results.json

      - name: Upload k6 results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: k6-results-${{ env.ENVIRONMENT }}
          path: k6-results.json
          retention-days: 30
